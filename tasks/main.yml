---
# tasks file for ansible-cmc-servers
- name: Set hostname
  hostname:
    name: "{{ cmc_server_hostname }}"

- name: Configure alias to admin
  lineinfile:
    path: "/etc/aliases"
    regexp: '^root: suporte'
    line: 'root: admin'

- name: Configure mail domain
  lineinfile:
    path: /etc/mailname
    state: present
    line: "cmc.pr.gov.br"

- name: Configure resolv.conf domain
  lineinfile:
    path: /etc/resolv.conf
    state: present
    line: "domain cmc.pr.gov.br"

- name: Configure resolv.conf domain search
  lineinfile:
    path: /etc/resolv.conf
    state: present
    line: "search cmc.pr.gov.br"

- name: Ensure template IP and name are removed from hosts file
  lineinfile:
    path: /etc/hosts
    state: absent
    regexp: '^10\.0\.0\.254'

- name: Ensure hosts is right
  lineinfile:
    path: /etc/hosts
    state: present
    line: "{{ ansible_default_ipv4.address }} {{ cmc_server_hostname }}.cmc.pr.gov.br {{ cmc_server_hostname }}"

- name: Install required system packages
  apt: name={{ item }} state=latest update_cache=yes
  loop: [ 'rsync', 'ntp', 'sudo', 'unattended-upgrades', 'software-properties-common', 'curl', 'vim', 'ncdu', 'iftop', 'nload' ]

- name: Configure NTP
  template:
    src: ntp.conf.j2
    dest: /etc/ntp.conf
    owner: root
    group: root
    mode: 0644
    backup: yes
  notify:
    - restart ntp

- name: Configure unattended-upgrades
  lineinfile:
    path: "/etc/apt/apt.conf.d/50unattended-upgrades"
    regexp: '^//Unattended-Upgrade::MinimalSteps'
    line: 'Unattended-Upgrade::MinimalSteps "true";'

- name: Configure unattended-upgrades
  lineinfile:
    path: "/etc/apt/apt.conf.d/50unattended-upgrades"
    regexp: '^//Unattended-Upgrade::Mail'
    line: 'Unattended-Upgrade::Mail "root";'

- name: Configure bash aliases
  copy:
    src: cmc-aliases.sh
    dest: /etc/profile.d/cmc-aliases.sh
    mode: 0644

- name: Configure command history
  lineinfile:
    path: /etc/bash.bashrc
    state: present
    line: "export HISTTIMEFORMAT=\"%F %T \""