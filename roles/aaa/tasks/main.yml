---
# tasks file for aaa

- name: Install required system packages
  apt:
    name:
      - acct
      - sudo
    state: latest
    update_cache: yes
    cache_valid_time: 86400

- name: Ensure empty sudo group
  lineinfile:
    path: "/etc/group"
    regexp: "^sudo:x:27:.+"
    line: "sudo:x:27:"

- name: Disable root SSH access
  lineinfile:
    path: /etc/ssh/sshd_config
    # lookahead para substituir qualquer coisa diferente de 'no'
    regexp: "^PermitRootLogin\\s+(?!no)"
    line: "PermitRootLogin no"
  notify:
    - Restart sshd

- name: Restrict SSH user groups
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^AllowGroups"
    line: "AllowGroups {{ cmc_aaa_ssh_user_groups }}" # type: space separated LDAP groups string
  notify:
    - Restart sshd

- name: Disable certificate checking
  lineinfile:
    path: /etc/nslcd.conf
    state: present
    line: "tls_reqcert never"
  notify:
    - Restart nslcd

- name: Create users home directory
  lineinfile:
    path: /etc/pam.d/common-session
    state: present
    insertbefore: "pam_unix\\.so"
    line: "session required pam_mkhomedir.so skel=/etc/skel/ umask=0022"

- name: Configure sudo
  template:
    src: sudoers.j2
    dest: /etc/sudoers.d/cmc
    owner: root
    group: root
    mode: "0440"
